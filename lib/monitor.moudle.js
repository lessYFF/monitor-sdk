import e from"rrweb/lib/record/rrweb-record";var r,n,t=window,o=document,i=t.console,c=t.navigator,a=t.performance,s=function(){var e;return null!=(e=c.deviceMemory)?e:0},u=function(){var e;return null!=(e=c.hardwareConcurrency)?e:0},f=function(e){return parseFloat(e.toFixed(2))},p=function(e){return"number"!=typeof e?null:f(e/Math.pow(1024,2))},l=function(){return a&&!!a.getEntriesByType&&!!a.now&&!!a.mark&&!!t.PerformanceObserver},d=[1e3,2500],v=[2500,4e3],m=[100,300],E=[.1,.25],h=[300,600],y={fp:d,fcp:d,lcp:v,lcpFinal:v,fid:m,fidVital:m,cls:E,clsFinal:E,tbt:h,tbt5s:h,tbt10s:h,tbtFinal:h},g=function(){if("connection"in c){var e=c.connection;return"object"!=typeof e?{}:{rtt:e.rtt,downlink:e.downlink,saveData:e.saveData,effectiveType:e.effectiveType}}},T=function(){return!!(u()&&u()<=4)||!!(s()&&s()<=4)},b={isHidden:!1},k=function(e){o.hidden&&(e(),b.isHidden=o.hidden)};!function(e){e[e.URGENT=1]="URGENT",e[e.IDLE=2]="IDLE"}(r||(r={})),function(e){e[e.SCRIPT=1]="SCRIPT",e[e.PROMISE=2]="PROMISE",e[e.NETWORK=3]="NETWORK",e[e.RECORD=4]="RECORD"}(n||(n={}));var w={isPerformanceTiming:!0,isResoureTiming:!0,isErrorCapture:!0,maxTime:15e3,report:null,analyticsTracker:null},S=function(){function e(e){if(!e.upUrl)throw Error("监控sdk需提供上报uri!");this.upUrl=e.upUrl}return e.prototype.sendToAnalytics=function(e,n,o){var i=o||this.upUrl;if(e===r.URGENT)if(t.fetch)fetch(i,{method:"post",body:n,keepalive:!0});else{var a=new XMLHttpRequest;a.open("post",i,!0),a.setRequestHeader("Content-Type","application/json"),a.send(n),a.onload=function(){200!==this.status&&304!==this.status||console.log("xhr response",this.response),a=null}}else if(e===r.IDLE)if(c.sendBeacon)c.sendBeacon(i,n);else{var s=new Image;s.src=i+"?body="+n,s.onload=function(){s=null}}},e.reportPerformance=function(e,r,n){var o;o=function(){var t,o;b.isHidden&&e.indexOf("Final")<0||!w.analyticsTracker||w.analyticsTracker({data:r,metricName:e,customProperties:n,score:(t=e,o=r,y[t]?o<=y[t][0]?"good":o<=y[t][1]?"needsImprovement":"poor":null),netWorkInfo:g(),navigatorInfo:c?{appName:c.appName,appVersion:c.appVersion,deviceMemory:s()||0,hardwareConcurrency:u()||0,isLowEndDevice:T(),isLowEndExperience:!c.connection||"object"!=typeof c.connection||!(!["lte","slow-2g","2g","3g"].includes(c.connection.effectiveType)&&!T),serviceWorkerStatus:"serviceWorker"in c?c.serviceWorker.controller?"controlled":"supported":"unSupported"}:{}})},"requestIdleCallback"in t?t.requestIdleCallback(o,{timeOut:3e3}):o()},e}(),O=function(e,r,n){Object.keys(r).forEach(function(e){"number"==typeof r[e]&&(r[e]=f(r[e]))}),S.reportPerformance(e,r,n)},D=function(e,r,n){var t=f(r);t>=0&&t<=w.maxTime&&S.reportPerformance(e,t,n)},R={fid:0,fcp:0,lcp:0,cls:0,tbt:0},I=function(e){console.log("analyticsTracker",e)},M=new(function(){function e(){this.perfObserveMap=new Map}var r=e.prototype;return r.poConnect=function(e,r){try{var n=new PerformanceObserver(function(e){r(e.getEntries())});n.observe({type:e,buffered:!0}),this.perfObserveMap.set(e,n)}catch(e){i.warn("poConnect warn",e)}},r.poDisconnect=function(e){this.perfObserveMap.get(e)&&(this.perfObserveMap.get(e).disconnect(),this.perfObserveMap.delete(e))},e}()),C=function(e){e.forEach(function(e){"first-paint"===e.name?D("fp",e.startTime):"first-contentful-paint"===e.name&&(R.fcp=e.startTime,D("fcp",R.fcp))})},L=function(e){var r=e.useageDetails||{};O("storageEstimate",{quota:p(e.quota),usage:p(e.usage),caches:p(r.caches),indexedDB:p(r.indexedDB),ServiceWorker:p(r.ServiceWorker)})},P=function(){console.log("⏰ 性能收集开始",Math.random()),M.poConnect("paint",C),O("navigationTiming",function(){if(!l)return{};var e=performance.getEntriesByType("navigation")[0];if(!e)return{};var r=e.responseStart,n=e.responseEnd;return{fetchTime:n-e.fetchStart||0,workerTime:e.workerStart?n-e.workerStart:0,totalTime:n-e.requestStart||0,downloadTime:n-r||0,timeToFirstByte:r-e.fetchStart||0,headerSize:e.transferSize-e.encodedBodySize||0,dnsLookupTime:e.dnsLookupTimeEnd-e.dnsLookupTimeStart||0,tcpTime:e.connectEnd-e.connectStart||0,whiteTime:r-e.navigationStart||0,domTime:e.domContentLoadedEventEnd-e.navigationStart||0,loadTime:e.loadEventEnd-e.navigationStart||0,parseDomTime:e.domComplete-e.domInteractive||0}}()),c&&c.storage&&"function"==typeof c.storage.estimate&&c.storage.estimate().then(L),void 0!==o.hidden&&o.addEventListener("visibilitychange",k.bind(void 0,N))},N=function(){var e;e=["paint"],(Array.isArray(e)?e:[e]).forEach(function(e){M.poDisconnect(e),D(e,R[e])})},U=function(){function o(){this.recordEvents=[]}var i=o.prototype;return i.recordAction=function(){var r=this;e({emit:function(e,n){n&&(r.recordEvents=[]),r.recordEvents.push(e)},checkoutEveryNth:100,checkoutEveryNms:3e5})},i.grobalError=function(){t.onerror=function(e,t,o,i,c){console.log("[ ❌全局捕获错误 ]",c);var a=JSON.stringify({source:t,lineno:o,colno:i,error:c,type:n[1]});return w.report.sendToAnalytics(r.IDLE,a),!0}},i.promiseError=function(){t.addEventListener("unhandledrejection",function(e){console.log("[ ❌promise捕获错误 ]",e),e.preventDefault();var t=JSON.stringify({e:e,type:n[2]});return w.report.sendToAnalytics(r.IDLE,t),!0})},i.networkError=function(){t.addEventListener("error",function(e){if(e.target!==t){console.log("[ ❌资源请求捕获错误 ]",e.target);var o=JSON.stringify({e:e,type:n[2]});w.report.sendToAnalytics(r.IDLE,o)}},!0)},i.consoleErrorReflect=function(){var e=t.console.error;t.console.error=function(){console.log("[ ❌console.error捕获错误 ]"),e.apply(t,Array.prototype.slice.call(arguments))}},i.run=function(){this.recordAction(),this.grobalError(),this.promiseError(),this.networkError(),this.consoleErrorReflect()},o}(),x=function(){function e(e){if(this.version="0.0.1",!e.upUrl)throw Error("监控sdk-"+this.version+"需提供上报uri!");Object.assign(w,e),w.report=new S({upUrl:e.upUrl}),w.analyticsTracker=w.analyticsTracker||I,this.report=w.report,this.initErrorMonitor(w),this.initPerformanceMonitor(w)}var r=e.prototype;return r.initErrorMonitor=function(e){e.isErrorCapture&&(new U).run()},r.initPerformanceMonitor=function(e){l()&&e.isPerformanceTiming&&P()},e}();export{x as YMonitor};
//# sourceMappingURL=monitor.moudle.js.map
