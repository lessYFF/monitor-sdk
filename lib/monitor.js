function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r,n,t=e(require("rrweb/lib/record/rrweb-record")),o=window,i=document,c=o.console,a=o.navigator,s=o.performance,u=function(){var e;return null!=(e=a.deviceMemory)?e:0},f=function(){var e;return null!=(e=a.hardwareConcurrency)?e:0},p=function(e){return parseFloat(e.toFixed(2))},l=function(e){return"number"!=typeof e?null:p(e/Math.pow(1024,2))},d=function(){return s&&!!s.getEntriesByType&&!!s.now&&!!s.mark&&!!o.PerformanceObserver},v=[1e3,2500],m=[2500,4e3],E=[100,300],h=[.1,.25],y=[300,600],g={fp:v,fcp:v,lcp:m,lcpFinal:m,fid:E,fidVital:E,cls:h,clsFinal:h,tbt:y,tbt5s:y,tbt10s:y,tbtFinal:y},T=function(){if("connection"in a){var e=a.connection;return"object"!=typeof e?{}:{rtt:e.rtt,downlink:e.downlink,saveData:e.saveData,effectiveType:e.effectiveType}}},b=function(){return!!(f()&&f()<=4)||!!(u()&&u()<=4)},k={isHidden:!1},w=function(e){i.hidden&&(e(),k.isHidden=i.hidden)};!function(e){e[e.URGENT=1]="URGENT",e[e.IDLE=2]="IDLE"}(r||(r={})),function(e){e[e.SCRIPT=1]="SCRIPT",e[e.PROMISE=2]="PROMISE",e[e.NETWORK=3]="NETWORK",e[e.RECORD=4]="RECORD"}(n||(n={}));var S={isPerformanceTiming:!0,isResoureTiming:!0,isErrorCapture:!0,maxTime:15e3,report:null,analyticsTracker:null},O=function(){function e(e){if(!e.upUrl)throw Error("监控sdk需提供上报uri!");this.upUrl=e.upUrl}return e.prototype.sendToAnalytics=function(e,n,t){var i=t||this.upUrl;if(e===r.URGENT)if(o.fetch)fetch(i,{method:"post",body:n,keepalive:!0});else{var c=new XMLHttpRequest;c.open("post",i,!0),c.setRequestHeader("Content-Type","application/json"),c.send(n),c.onload=function(){200!==this.status&&304!==this.status||console.log("xhr response",this.response),c=null}}else if(e===r.IDLE)if(a.sendBeacon)a.sendBeacon(i,n);else{var s=new Image;s.src=i+"?body="+n,s.onload=function(){s=null}}},e.reportPerformance=function(e,r,n){var t;t=function(){var t,o;k.isHidden&&e.indexOf("Final")<0||!S.analyticsTracker||S.analyticsTracker({data:r,metricName:e,customProperties:n,score:(t=e,o=r,g[t]?o<=g[t][0]?"good":o<=g[t][1]?"needsImprovement":"poor":null),netWorkInfo:T(),navigatorInfo:a?{appName:a.appName,appVersion:a.appVersion,deviceMemory:u()||0,hardwareConcurrency:f()||0,isLowEndDevice:b(),isLowEndExperience:!a.connection||"object"!=typeof a.connection||!(!["lte","slow-2g","2g","3g"].includes(a.connection.effectiveType)&&!b),serviceWorkerStatus:"serviceWorker"in a?a.serviceWorker.controller?"controlled":"supported":"unSupported"}:{}})},"requestIdleCallback"in o?o.requestIdleCallback(t,{timeOut:3e3}):t()},e}(),D=function(e,r,n){Object.keys(r).forEach(function(e){"number"==typeof r[e]&&(r[e]=p(r[e]))}),O.reportPerformance(e,r,n)},M=function(e,r,n){var t=p(r);t>=0&&t<=S.maxTime&&O.reportPerformance(e,t,n)},R={fid:0,fcp:0,lcp:0,cls:0,tbt:0},I=function(e){console.log("analyticsTracker",e)},C=new(function(){function e(){this.perfObserveMap=new Map}var r=e.prototype;return r.poConnect=function(e,r){try{var n=new PerformanceObserver(function(e){r(e.getEntries())});n.observe({type:e,buffered:!0}),this.perfObserveMap.set(e,n)}catch(e){c.warn("poConnect warn",e)}},r.poDisconnect=function(e){this.perfObserveMap.get(e)&&(this.perfObserveMap.get(e).disconnect(),this.perfObserveMap.delete(e))},e}()),L=function(e){e.forEach(function(e){"first-paint"===e.name?M("fp",e.startTime):"first-contentful-paint"===e.name&&(R.fcp=e.startTime,M("fcp",R.fcp))})},P=function(e){var r=e.useageDetails||{};D("storageEstimate",{quota:l(e.quota),usage:l(e.usage),caches:l(r.caches),indexedDB:l(r.indexedDB),ServiceWorker:l(r.ServiceWorker)})},N=function(){console.log("⏰ 性能收集开始",Math.random()),C.poConnect("paint",L),D("navigationTiming",function(){if(!d)return{};var e=performance.getEntriesByType("navigation")[0];if(!e)return{};var r=e.responseStart,n=e.responseEnd;return{fetchTime:n-e.fetchStart||0,workerTime:e.workerStart?n-e.workerStart:0,totalTime:n-e.requestStart||0,downloadTime:n-r||0,timeToFirstByte:r-e.fetchStart||0,headerSize:e.transferSize-e.encodedBodySize||0,dnsLookupTime:e.dnsLookupTimeEnd-e.dnsLookupTimeStart||0,tcpTime:e.connectEnd-e.connectStart||0,whiteTime:r-e.navigationStart||0,domTime:e.domContentLoadedEventEnd-e.navigationStart||0,loadTime:e.loadEventEnd-e.navigationStart||0,parseDomTime:e.domComplete-e.domInteractive||0}}()),a&&a.storage&&"function"==typeof a.storage.estimate&&a.storage.estimate().then(P),void 0!==i.hidden&&i.addEventListener("visibilitychange",w.bind(void 0,U))},U=function(){var e;e=["paint"],(Array.isArray(e)?e:[e]).forEach(function(e){C.poDisconnect(e),M(e,R[e])})},x=function(){function e(){this.recordEvents=[]}var i=e.prototype;return i.recordAction=function(){var e=this;t.default({emit:function(r,n){n&&(e.recordEvents=[]),e.recordEvents.push(r)},checkoutEveryNth:100,checkoutEveryNms:3e5})},i.grobalError=function(){o.onerror=function(e,t,o,i,c){console.log("[ ❌全局捕获错误 ]",c);var a=JSON.stringify({source:t,lineno:o,colno:i,error:c,type:n[1]});return S.report.sendToAnalytics(r.IDLE,a),!0}},i.promiseError=function(){o.addEventListener("unhandledrejection",function(e){console.log("[ ❌promise捕获错误 ]",e),e.preventDefault();var t=JSON.stringify({e:e,type:n[2]});return S.report.sendToAnalytics(r.IDLE,t),!0})},i.networkError=function(){o.addEventListener("error",function(e){if(e.target!==o){console.log("[ ❌资源请求捕获错误 ]",e.target);var t=JSON.stringify({e:e,type:n[2]});S.report.sendToAnalytics(r.IDLE,t)}},!0)},i.consoleErrorReflect=function(){var e=o.console.error;o.console.error=function(){console.log("[ ❌console.error捕获错误 ]"),e.apply(o,Array.prototype.slice.call(arguments))}},i.run=function(){this.recordAction(),this.grobalError(),this.promiseError(),this.networkError(),this.consoleErrorReflect()},e}();exports.YMonitor=function(){function e(e){if(this.version="0.0.1",!e.upUrl)throw Error("监控sdk-"+this.version+"需提供上报uri!");Object.assign(S,e),S.report=new O({upUrl:e.upUrl}),S.analyticsTracker=S.analyticsTracker||I,this.report=S.report,this.initErrorMonitor(S),this.initPerformanceMonitor(S)}var r=e.prototype;return r.initErrorMonitor=function(e){e.isErrorCapture&&(new x).run()},r.initPerformanceMonitor=function(e){d()&&e.isPerformanceTiming&&N()},e}();
//# sourceMappingURL=monitor.js.map
