!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("rrweb/lib/record/rrweb-record")):"function"==typeof define&&define.amd?define(["exports","rrweb/lib/record/rrweb-record"],r):r((e||self).monitor={},e.record)}(this,function(e,r){function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var t,o,i=n(r),c=window,a=document,s=c.console,f=c.navigator,u=c.performance,p=function(){var e;return null!=(e=f.deviceMemory)?e:0},l=function(){var e;return null!=(e=f.hardwareConcurrency)?e:0},d=function(e){return parseFloat(e.toFixed(2))},v=function(e){return"number"!=typeof e?null:d(e/Math.pow(1024,2))},m=function(){return u&&!!u.getEntriesByType&&!!u.now&&!!u.mark&&!!c.PerformanceObserver},y=[1e3,2500],h=[2500,4e3],E=[100,300],g=[.1,.25],T=[300,600],b={fp:y,fcp:y,lcp:h,lcpFinal:h,fid:E,fidVital:E,cls:g,clsFinal:g,tbt:T,tbt5s:T,tbt10s:T,tbtFinal:T},w=function(){if("connection"in f){var e=f.connection;return"object"!=typeof e?{}:{rtt:e.rtt,downlink:e.downlink,saveData:e.saveData,effectiveType:e.effectiveType}}},k=function(){return!!(l()&&l()<=4)||!!(p()&&p()<=4)},S={isHidden:!1},O=function(e){a.hidden&&(e(),S.isHidden=a.hidden)};!function(e){e[e.URGENT=1]="URGENT",e[e.IDLE=2]="IDLE"}(t||(t={})),function(e){e[e.SCRIPT=1]="SCRIPT",e[e.PROMISE=2]="PROMISE",e[e.NETWORK=3]="NETWORK",e[e.RECORD=4]="RECORD"}(o||(o={}));var D={isPerformanceTiming:!0,isResoureTiming:!0,isErrorCapture:!0,maxTime:15e3,report:null,analyticsTracker:null},M=function(){function e(e){if(!e.upUrl)throw Error("监控sdk需提供上报uri!");this.upUrl=e.upUrl}return e.prototype.sendToAnalytics=function(e,r,n){var o=n||this.upUrl;if(e===t.URGENT)if(c.fetch)fetch(o,{method:"post",body:r,keepalive:!0});else{var i=new XMLHttpRequest;i.open("post",o,!0),i.setRequestHeader("Content-Type","application/json"),i.send(r),i.onload=function(){200!==this.status&&304!==this.status||console.log("xhr response",this.response),i=null}}else if(e===t.IDLE)if(f.sendBeacon)f.sendBeacon(o,r);else{var a=new Image;a.src=o+"?body="+r,a.onload=function(){a=null}}},e.reportPerformance=function(e,r,n){var t;t=function(){var t,o;S.isHidden&&e.indexOf("Final")<0||!D.analyticsTracker||D.analyticsTracker({data:r,metricName:e,customProperties:n,score:(t=e,o=r,b[t]?o<=b[t][0]?"good":o<=b[t][1]?"needsImprovement":"poor":null),netWorkInfo:w(),navigatorInfo:f?{appName:f.appName,appVersion:f.appVersion,deviceMemory:p()||0,hardwareConcurrency:l()||0,isLowEndDevice:k(),isLowEndExperience:!f.connection||"object"!=typeof f.connection||!(!["lte","slow-2g","2g","3g"].includes(f.connection.effectiveType)&&!k),serviceWorkerStatus:"serviceWorker"in f?f.serviceWorker.controller?"controlled":"supported":"unSupported"}:{}})},"requestIdleCallback"in c?c.requestIdleCallback(t,{timeOut:3e3}):t()},e}(),R=function(e,r,n){Object.keys(r).forEach(function(e){"number"==typeof r[e]&&(r[e]=d(r[e]))}),M.reportPerformance(e,r,n)},I=function(e,r,n){var t=d(r);t>=0&&t<=D.maxTime&&M.reportPerformance(e,t,n)},C={fid:0,fcp:0,lcp:0,cls:0,tbt:0},L=function(e){console.log("analyticsTracker",e)},P=new(function(){function e(){this.perfObserveMap=new Map}var r=e.prototype;return r.poConnect=function(e,r){try{var n=new PerformanceObserver(function(e){r(e.getEntries())});n.observe({type:e,buffered:!0}),this.perfObserveMap.set(e,n)}catch(e){s.warn("poConnect warn",e)}},r.poDisconnect=function(e){this.perfObserveMap.get(e)&&(this.perfObserveMap.get(e).disconnect(),this.perfObserveMap.delete(e))},e}()),N=function(e){e.forEach(function(e){"first-paint"===e.name?I("fp",e.startTime):"first-contentful-paint"===e.name&&(C.fcp=e.startTime,I("fcp",C.fcp))})},x=function(e){var r=e.useageDetails||{};R("storageEstimate",{quota:v(e.quota),usage:v(e.usage),caches:v(r.caches),indexedDB:v(r.indexedDB),ServiceWorker:v(r.ServiceWorker)})},U=function(){console.log("⏰ 性能收集开始",Math.random()),P.poConnect("paint",N),R("navigationTiming",function(){if(!m)return{};var e=performance.getEntriesByType("navigation")[0];if(!e)return{};var r=e.responseStart,n=e.responseEnd;return{fetchTime:n-e.fetchStart||0,workerTime:e.workerStart?n-e.workerStart:0,totalTime:n-e.requestStart||0,downloadTime:n-r||0,timeToFirstByte:r-e.fetchStart||0,headerSize:e.transferSize-e.encodedBodySize||0,dnsLookupTime:e.dnsLookupTimeEnd-e.dnsLookupTimeStart||0,tcpTime:e.connectEnd-e.connectStart||0,whiteTime:r-e.navigationStart||0,domTime:e.domContentLoadedEventEnd-e.navigationStart||0,loadTime:e.loadEventEnd-e.navigationStart||0,parseDomTime:e.domComplete-e.domInteractive||0}}()),f&&f.storage&&"function"==typeof f.storage.estimate&&f.storage.estimate().then(x),void 0!==a.hidden&&a.addEventListener("visibilitychange",O.bind(void 0,A))},A=function(){var e;e=["paint"],(Array.isArray(e)?e:[e]).forEach(function(e){P.poDisconnect(e),I(e,C[e])})},j=function(){function e(){this.recordEvents=[]}var r=e.prototype;return r.recordAction=function(){var e=this;i.default({emit:function(r,n){n&&(e.recordEvents=[]),e.recordEvents.push(r)},checkoutEveryNth:100,checkoutEveryNms:3e5})},r.grobalError=function(){c.onerror=function(e,r,n,i,c){console.log("[ ❌全局捕获错误 ]",c);var a=JSON.stringify({source:r,lineno:n,colno:i,error:c,type:o[1]});return D.report.sendToAnalytics(t.IDLE,a),!0}},r.promiseError=function(){c.addEventListener("unhandledrejection",function(e){console.log("[ ❌promise捕获错误 ]",e),e.preventDefault();var r=JSON.stringify({e:e,type:o[2]});return D.report.sendToAnalytics(t.IDLE,r),!0})},r.networkError=function(){c.addEventListener("error",function(e){if(e.target!==c){console.log("[ ❌资源请求捕获错误 ]",e.target);var r=JSON.stringify({e:e,type:o[2]});D.report.sendToAnalytics(t.IDLE,r)}},!0)},r.consoleErrorReflect=function(){var e=c.console.error;c.console.error=function(){console.log("[ ❌console.error捕获错误 ]"),e.apply(c,Array.prototype.slice.call(arguments))}},r.run=function(){this.recordAction(),this.grobalError(),this.promiseError(),this.networkError(),this.consoleErrorReflect()},e}();e.YMonitor=function(){function e(e){if(this.version="0.0.1",!e.upUrl)throw Error("监控sdk-"+this.version+"需提供上报uri!");Object.assign(D,e),D.report=new M({upUrl:e.upUrl}),D.analyticsTracker=D.analyticsTracker||L,this.report=D.report,this.initErrorMonitor(D),this.initPerformanceMonitor(D)}var r=e.prototype;return r.initErrorMonitor=function(e){e.isErrorCapture&&(new j).run()},r.initPerformanceMonitor=function(e){m()&&e.isPerformanceTiming&&U()},e}()});
//# sourceMappingURL=monitor.umd.js.map
