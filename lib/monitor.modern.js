import e from"rrweb/lib/record/rrweb-record";const r=window,t=document,o=r.console,n=r.navigator,i=r.performance,s=()=>{var e;return null!=(e=n.deviceMemory)?e:0},c=()=>{var e;return null!=(e=n.hardwareConcurrency)?e:0},a=function(e){return parseFloat(e.toFixed(2))},l=function(e){return"number"!=typeof e?null:a(e/Math.pow(1024,2))},p=()=>i&&!!i.getEntriesByType&&!!i.now&&!!i.mark&&!!r.PerformanceObserver,d=[1e3,2500],u=[2500,4e3],f=[100,300],m=[.1,.25],E=[300,600],h={fp:d,fcp:d,lcp:u,lcpFinal:u,fid:f,fidVital:f,cls:m,clsFinal:m,tbt:E,tbt5s:E,tbt10s:E,tbtFinal:E},v=function(){if("connection"in n){const e=n.connection;return"object"!=typeof e?{}:{rtt:e.rtt,downlink:e.downlink,saveData:e.saveData,effectiveType:e.effectiveType}}},y=function(){return!!(c()&&c()<=4)||!!(s()&&s()<=4)},g={isHidden:!1},T=function(e){t.hidden&&(e(),g.isHidden=t.hidden)};var b,k;!function(e){e[e.URGENT=1]="URGENT",e[e.IDLE=2]="IDLE"}(b||(b={})),function(e){e[e.SCRIPT=1]="SCRIPT",e[e.PROMISE=2]="PROMISE",e[e.NETWORK=3]="NETWORK",e[e.RECORD=4]="RECORD"}(k||(k={}));const w={isPerformanceTiming:!0,isResoureTiming:!0,isErrorCapture:!0,maxTime:15e3,report:null,analyticsTracker:null};class S{constructor(e){if(!e.upUrl)throw Error("监控sdk需提供上报uri!");this.upUrl=e.upUrl}sendToAnalytics(e,t,o){const i=o||this.upUrl;if(e===b.URGENT)if(r.fetch)fetch(i,{method:"post",body:t,keepalive:!0});else{let e=new XMLHttpRequest;e.open("post",i,!0),e.setRequestHeader("Content-Type","application/json"),e.send(t),e.onload=function(){200!==this.status&&304!==this.status||console.log("xhr response",this.response),e=null}}else if(e===b.IDLE)if(n.sendBeacon)n.sendBeacon(i,t);else{let e=new Image;e.src=`${i}?body=${t}`,e.onload=function(){e=null}}}static reportPerformance(e,t,o){var i;i=()=>{var r,i;g.isHidden&&e.indexOf("Final")<0||!w.analyticsTracker||w.analyticsTracker({data:t,metricName:e,customProperties:o,score:(r=e,i=t,h[r]?i<=h[r][0]?"good":i<=h[r][1]?"needsImprovement":"poor":null),netWorkInfo:v(),navigatorInfo:n?{appName:n.appName,appVersion:n.appVersion,deviceMemory:s()||0,hardwareConcurrency:c()||0,isLowEndDevice:y(),isLowEndExperience:!n.connection||"object"!=typeof n.connection||!(!["lte","slow-2g","2g","3g"].includes(n.connection.effectiveType)&&!y),serviceWorkerStatus:"serviceWorker"in n?n.serviceWorker.controller?"controlled":"supported":"unSupported"}:{}})},"requestIdleCallback"in r?r.requestIdleCallback(i,{timeOut:3e3}):i()}}const O=(e,r,t)=>{Object.keys(r).forEach(e=>{"number"==typeof r[e]&&(r[e]=a(r[e]))}),S.reportPerformance(e,r,t)},D=(e,r,t)=>{const o=a(r);o>=0&&o<=w.maxTime&&S.reportPerformance(e,o,t)},R={fid:0,fcp:0,lcp:0,cls:0,tbt:0},I=function(e){console.log("analyticsTracker",e)},M=new class{constructor(){this.perfObserveMap=new Map}poConnect(e,r){try{const t=new PerformanceObserver(e=>{r(e.getEntries())});t.observe({type:e,buffered:!0}),this.perfObserveMap.set(e,t)}catch(e){o.warn("poConnect warn",e)}}poDisconnect(e){this.perfObserveMap.get(e)&&(this.perfObserveMap.get(e).disconnect(),this.perfObserveMap.delete(e))}},C=e=>{e.forEach(e=>{"first-paint"===e.name?D("fp",e.startTime):"first-contentful-paint"===e.name&&(R.fcp=e.startTime,D("fcp",R.fcp))})},L=e=>{const r=e.useageDetails||{};O("storageEstimate",{quota:l(e.quota),usage:l(e.usage),caches:l(r.caches),indexedDB:l(r.indexedDB),ServiceWorker:l(r.ServiceWorker)})},P=()=>{console.log("⏰ 性能收集开始",Math.random()),M.poConnect("paint",C),O("navigationTiming",(()=>{if(!p)return{};const e=performance.getEntriesByType("navigation")[0];if(!e)return{};const r=e.responseStart,t=e.responseEnd;return{fetchTime:t-e.fetchStart||0,workerTime:e.workerStart?t-e.workerStart:0,totalTime:t-e.requestStart||0,downloadTime:t-r||0,timeToFirstByte:r-e.fetchStart||0,headerSize:e.transferSize-e.encodedBodySize||0,dnsLookupTime:e.dnsLookupTimeEnd-e.dnsLookupTimeStart||0,tcpTime:e.connectEnd-e.connectStart||0,whiteTime:r-e.navigationStart||0,domTime:e.domContentLoadedEventEnd-e.navigationStart||0,loadTime:e.loadEventEnd-e.navigationStart||0,parseDomTime:e.domComplete-e.domInteractive||0}})()),n&&n.storage&&"function"==typeof n.storage.estimate&&n.storage.estimate().then(L),void 0!==t.hidden&&t.addEventListener("visibilitychange",T.bind(void 0,N))},N=()=>{var e;e=["paint"],(Array.isArray(e)?e:[e]).forEach(e=>{M.poDisconnect(e),D(e,R[e])})};class U{constructor(){this.recordEvents=[]}recordAction(){const r=this;e({emit(e,t){t&&(r.recordEvents=[]),r.recordEvents.push(e)},checkoutEveryNth:100,checkoutEveryNms:3e5})}grobalError(){r.onerror=(e,r,t,o,n)=>{console.log("[ ❌全局捕获错误 ]",n);const i=JSON.stringify({source:r,lineno:t,colno:o,error:n,type:k[1]});return w.report.sendToAnalytics(b.IDLE,i),!0}}promiseError(){r.addEventListener("unhandledrejection",function(e){console.log("[ ❌promise捕获错误 ]",e),e.preventDefault();const r=JSON.stringify({e,type:k[2]});return w.report.sendToAnalytics(b.IDLE,r),!0})}networkError(){r.addEventListener("error",function(e){if(e.target!==r){console.log("[ ❌资源请求捕获错误 ]",e.target);const r=JSON.stringify({e,type:k[2]});w.report.sendToAnalytics(b.IDLE,r)}},!0)}consoleErrorReflect(){const e=r.console.error;r.console.error=function(){console.log("[ ❌console.error捕获错误 ]"),e.apply(r,[...arguments])}}run(){this.recordAction(),this.grobalError(),this.promiseError(),this.networkError(),this.consoleErrorReflect()}}class x{constructor(e){if(this.version="0.0.1",!e.upUrl)throw Error(`监控sdk-${this.version}需提供上报uri!`);Object.assign(w,e),w.report=new S({upUrl:e.upUrl}),w.analyticsTracker=w.analyticsTracker||I,this.report=w.report,this.initErrorMonitor(w),this.initPerformanceMonitor(w)}initErrorMonitor(e){e.isErrorCapture&&(new U).run()}initPerformanceMonitor(e){p()&&e.isPerformanceTiming&&P()}}export{x as YMonitor};
//# sourceMappingURL=monitor.modern.js.map
